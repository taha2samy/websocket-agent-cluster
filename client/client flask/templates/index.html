<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flask WebSocket Client</title>
    <!-- Link to the external CSS file -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h2>WebSocket Web Client</h2>

        <div class="frame">
            <h3>Connection Details</h3>
            <div class="form-grid">
                <label for="ip">IP:</label> <input type="text" id="ip" value="localhost">
                <label for="port">Port:</label> <input type="text" id="port" value="8000">
                <label for="token">Token:</label> <input type="text" id="token" placeholder="Enter your token">
                <label for="tags">Tags:</label> <input type="text" id="tags" placeholder="news,sports (comma-separated)">
            </div>
            <div class="button-group">
                <button id="connectBtn" onclick="connect()">Connect</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
            </div>
        </div>

        <div class="frame">
            <h3>Send Message</h3>
            <div class="form-grid">
                <label for="message">Message:</label>
                <input type="text" id="message" placeholder="Enter message to send">
            </div>
            <div class="button-group">
                 <button id="sendBtn" onclick="sendMessage()" disabled>Send Message</button>
            </div>
        </div>

        <div class="frame">
            <h3>Received Messages</h3>
            <textarea id="received" readonly></textarea>
            <div class="button-group-right">
                <button onclick="clearMessages()">Clear Messages</button>
            </div>
        </div>
    </div>

    <script>
        // Global variable to hold the WebSocket instance
        let websocket = null;

        // Get references to UI elements
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const receivedArea = document.getElementById('received');

        function log(message) {
            // Append a new message to the textarea, with a timestamp
            const timestamp = new Date().toLocaleTimeString();
            receivedArea.value += `[${timestamp}] ${message}\n`;
            receivedArea.scrollTop = receivedArea.scrollHeight; // Auto-scroll to the bottom
        }

        function updateUIState(isConnected) {
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            sendBtn.disabled = !isConnected;
        }

        function connect() {
            if (websocket) {
                log("Already connected or connecting.");
                return;
            }

            const ip = document.getElementById('ip').value.trim();
            const port = document.getElementById('port').value.trim();
            const token = document.getElementById('token').value.trim();
            const tags = document.getElementById('tags').value.trim();

            if (!token) {
                alert("Token is required to connect.");
                return;
            }

            // Construct the URL with token and tags as query parameters
            const url = `ws://${ip}:${port}/?token=${encodeURIComponent(token)}&tags=${encodeURIComponent(tags)}`;
            
            log(`Attempting to connect to ${url}...`);
            websocket = new WebSocket(url);

            websocket.onopen = function(event) {
                log("Connection successful!");
                updateUIState(true);
            };

            websocket.onmessage = function(event) {
                log(`Received: ${event.data}`);
            };

            websocket.onclose = function(event) {
                log(`Connection closed. Code: ${event.code}, Reason: ${event.reason || 'N/A'}`);
                updateUIState(false);
                websocket = null;
            };

            websocket.onerror = function(event) {
                log("An error occurred. Check the browser console for details.");
                console.error("WebSocket Error:", event);
            };
        }

        function disconnect() {
            if (websocket) {
                log("Disconnecting...");
                websocket.close();
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('message');
            const message = messageInput.value;
            if (websocket && websocket.readyState === WebSocket.OPEN && message) {
                websocket.send(message);
                log(`Sent: ${message}`);
                messageInput.value = ''; // Clear input after sending
            } else {
                log("Cannot send message. WebSocket is not connected or message is empty.");
            }
        }
        
        function clearMessages() {
            receivedArea.value = '';
        }

    </script>
</body>
</html>